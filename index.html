<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Epistellaire — Livre numérique</title>
  <meta name="description" content="Feuilletez Epistellaire, un livre numérique sensible et lumineux, pensé comme une œuvre d'art en devenir." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/page-flip/dist/css/page-flip.min.css" />
  <style>
    :root {
      color-scheme: only light;
      --ink: #1f1a28;
      --ink-muted: rgba(31, 26, 40, 0.65);
      --paper: #f7f2ec;
      --paper-soft: rgba(255, 255, 255, 0.9);
      --accent: #c6a6cf;
      --accent-strong: #9a78b5;
      --shadow: 0 30px 80px rgba(67, 56, 86, 0.22);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at 20% 20%, rgba(211, 201, 222, 0.5), transparent 45%),
        radial-gradient(circle at 80% 0%, rgba(183, 207, 214, 0.35), transparent 40%),
        linear-gradient(120deg, #fbf8f4 0%, #f3ece4 48%, #f7f1ea 100%);
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .grain {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg width='120' height='120' viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='0.12'/%3E%3C/svg%3E");
      mix-blend-mode: soft-light;
      opacity: 0.6;
      z-index: 0;
    }

    .shell {
      width: min(1200px, 100%);
      padding: clamp(28px, 6vw, 72px);
      display: flex;
      flex-direction: column;
      gap: clamp(28px, 4vw, 56px);
      position: relative;
      z-index: 1;
    }

    header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 20px;
      flex-wrap: wrap;
    }

    .identity {
      max-width: 480px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .identity h1 {
      margin: 0;
      font-family: "Playfair Display", "Times New Roman", serif;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: clamp(2.4rem, 4vw, 3.5rem);
    }

    .identity p {
      margin: 0;
      font-size: clamp(1rem, 1.4vw, 1.2rem);
      line-height: 1.7;
      color: var(--ink-muted);
    }

    .meta {
      display: grid;
      gap: 8px;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.26em;
      color: rgba(31, 26, 40, 0.55);
    }

    main {
      display: grid;
      grid-template-columns: minmax(240px, 320px) minmax(0, 1fr);
      gap: clamp(28px, 6vw, 80px);
      align-items: center;
    }

    .aside {
      display: grid;
      gap: 20px;
    }

    .aside-card {
      padding: 20px 22px;
      border-radius: 24px;
      background: rgba(255, 255, 255, 0.75);
      border: 1px solid rgba(170, 156, 187, 0.25);
      box-shadow: 0 20px 40px rgba(86, 76, 102, 0.14);
      backdrop-filter: blur(12px);
    }

    .aside-card h2 {
      margin: 0 0 8px;
      font-size: 0.9rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    .aside-card p {
      margin: 0;
      font-size: 0.95rem;
      line-height: 1.6;
      color: var(--ink-muted);
    }

    .viewer {
      position: relative;
      display: grid;
      gap: 16px;
    }

    .book-wrapper {
      position: relative;
      width: 100%;
      padding: clamp(16px, 3vw, 26px);
      border-radius: 32px;
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.85), rgba(234, 226, 239, 0.2));
      box-shadow: var(--shadow);
      border: 1px solid rgba(170, 156, 187, 0.25);
      isolation: isolate;
    }

    .book-wrapper::before {
      content: "";
      position: absolute;
      inset: 22px;
      border-radius: 22px;
      background:
        linear-gradient(90deg, rgba(77, 62, 102, 0.22), rgba(77, 62, 102, 0) 10%, rgba(77, 62, 102, 0) 90%, rgba(77, 62, 102, 0.22)),
        radial-gradient(circle at center, rgba(255, 255, 255, 0.22), rgba(0, 0, 0, 0.05));
      pointer-events: none;
      z-index: 0;
    }

    #book {
      width: 100%;
      height: min(60vh, 520px);
      aspect-ratio: 16 / 9;
      border-radius: 24px;
      overflow: hidden;
      background: linear-gradient(160deg, #fffaf5 0%, #f4eee7 100%);
      box-shadow: 0 22px 60px rgba(66, 56, 84, 0.2);
      perspective: 1800px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    #book::before {
      content: "";
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%;
      width: 28px;
      transform: translateX(-50%);
      background: linear-gradient(90deg, rgba(53, 41, 69, 0.16), rgba(255, 255, 255, 0.08), rgba(53, 41, 69, 0.18));
      filter: blur(0.5px);
      pointer-events: none;
      z-index: 5;
    }

    #book.book-fallback {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 100%;
      align-items: stretch;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
    }

    #book.book-fallback .page {
      scroll-snap-align: start;
    }

    .page {
      background: linear-gradient(120deg, #fffdfa 0%, #f2ece4 100%);
      border-radius: 12px;
      box-shadow:
        inset 0 0 0 1px rgba(210, 196, 214, 0.5),
        inset 0 -18px 30px rgba(161, 144, 173, 0.18);
      overflow: hidden;
      position: relative;
    }

    .page.page--cover {
      background: linear-gradient(140deg, #eee3d6 0%, #d5c5af 100%);
      box-shadow:
        inset 0 0 0 1px rgba(129, 104, 72, 0.45),
        inset 0 -10px 26px rgba(94, 70, 42, 0.22);
    }

    .page::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        linear-gradient(90deg, rgba(38, 28, 48, 0.15), rgba(38, 28, 48, 0)),
        linear-gradient(180deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0));
      opacity: 0.2;
      pointer-events: none;
    }

    .page::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      box-shadow: inset -12px 0 18px rgba(98, 79, 122, 0.12);
      opacity: 0.6;
      pointer-events: none;
    }

    .page img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: saturate(0.98) contrast(1.02);
    }

    #book.book-fallback .page img {
      object-fit: contain;
      background: #f6f1ea;
    }

    .toolbar {
      display: grid;
      gap: 12px;
      align-items: center;
      grid-template-columns: auto 1fr auto;
      padding: 14px 20px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(170, 156, 187, 0.25);
      box-shadow: 0 18px 36px rgba(78, 66, 94, 0.18);
      backdrop-filter: blur(10px);
    }

    .toolbar button {
      border: none;
      background: rgba(220, 209, 232, 0.7);
      color: var(--ink);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 1.2rem;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: transform 150ms ease, background 150ms ease;
    }

    .toolbar button:hover,
    .toolbar button:focus-visible {
      transform: translateY(-1px);
      background: rgba(211, 197, 228, 0.9);
      outline: none;
    }

    .toolbar .page-label {
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      font-size: 0.68rem;
      color: rgba(31, 26, 40, 0.6);
    }

    .page-title {
      text-align: center;
      font-family: "Playfair Display", "Times New Roman", serif;
      font-size: 1.1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .scrub {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.75);
      border: 1px solid rgba(170, 156, 187, 0.2);
    }

    .scrub input[type="range"] {
      flex: 1;
      accent-color: var(--accent-strong);
    }

    .scrub .count {
      font-size: 0.75rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(31, 26, 40, 0.6);
      white-space: nowrap;
    }

    @media (max-width: 960px) {
      main {
        grid-template-columns: 1fr;
      }

      .toolbar {
        grid-template-columns: 1fr;
        justify-items: center;
        gap: 10px;
      }

      .toolbar button {
        width: 36px;
        height: 36px;
      }
    }

    @media (max-width: 720px) {
      .shell {
        padding: 32px 22px 48px;
      }

      #book {
        height: min(58vh, 460px);
      }

      .toolbar {
        border-radius: 24px;
        padding: 12px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="grain" aria-hidden="true"></div>
  <div class="shell">
    <header>
      <div class="identity">
        <h1>Epistellaire</h1>
        <p>Un livre numérique.lorem ipsum </p>
      </div>
      <div class="meta">
        <span>Atelier numérique</span>
        <span>Œuvre en cours</span>
      </div>
    </header>

    <main>
      <aside class="aside">
        <div class="aside-card">
          <h2>Intention</h2>
          <p>Naviguez librement entre les pages pour saisir la progression artistique.</p>
        </div>
        <div class="aside-card">
          <h2>Navigation</h2>
          <p>Cliquez sur les bords du livre, utilisez les flèches ou glissez le curseur pour atteindre une page précise.</p>
        </div>
      </aside>

      <section class="viewer" aria-label="Livre numérique">
        <div class="book-wrapper">
          <div id="book" aria-live="polite"></div>
        </div>
        <div class="toolbar" role="toolbar" aria-label="Contrôles du livre">
          <button type="button" data-action="prev" aria-label="Page précédente">‹</button>
          <div>
            <div class="page-label" id="pageIndicator">Chargement des pages…</div>
            <div class="page-title" id="pageTitle">&nbsp;</div>
          </div>
          <button type="button" data-action="next" aria-label="Page suivante">›</button>
        </div>
        <div class="scrub" aria-label="Navigation rapide">
          <span class="count" id="scrubCount">Page 1</span>
          <input type="range" min="1" max="1" value="1" step="1" id="pageScrubber" aria-label="Aller à la page" />
          <span class="count" id="totalCount">/ 1</span>
        </div>
      </section>
    </main>
  </div>

  <!-- PAGES_DATA_START -->
  <script type="application/json" id="pagesData">
[
  {
    "src": "assets/pages/001.jpg",
    "title": "Couverture"
  },
  {
    "src": "assets/pages/002.jpg",
    "title": "002"
  },
  {
    "src": "assets/pages/003.jpg",
    "title": "003"
  },
  {
    "src": "assets/pages/004.jpg",
    "title": "004"
  },
  {
    "src": "assets/pages/005.jpg",
    "title": "005"
  },
  {
    "src": "assets/pages/006.jpg",
    "title": "006"
  },
  {
    "src": "assets/pages/007.jpg",
    "title": "007"
  },
  {
    "src": "assets/pages/008.jpg",
    "title": "008"
  },
  {
    "src": "assets/pages/009.jpg",
    "title": "009"
  }
]
  </script>
  <!-- PAGES_DATA_END -->

  <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.min.js"></script>
  <script>
    (function () {
      const bookEl = document.getElementById('book');
      const pageIndicator = document.getElementById('pageIndicator');
      const pageTitle = document.getElementById('pageTitle');
      const pageScrubber = document.getElementById('pageScrubber');
      const scrubCount = document.getElementById('scrubCount');
      const totalCount = document.getElementById('totalCount');
      const navButtons = Array.from(document.querySelectorAll('[data-action]'));
      let fallbackActive = false;
      let fallbackPages = [];
      let bookInstance = null;

      const inlinePages = (() => {
        const dataEl = document.getElementById('pagesData');
        if (!dataEl) return [];
        try {
          return JSON.parse(dataEl.textContent);
        } catch (error) {
          console.warn('Impossible de lire les pages intégrées.', error);
          return [];
        }
      })();

      const loadPages = async () => {
        if (location.protocol === 'file:' && inlinePages.length) {
          return inlinePages;
        }

        try {
          const response = await fetch('pages.json', { cache: 'no-store' });
          if (!response.ok) {
            throw new Error(`Réponse inattendue (${response.status})`);
          }
          return await response.json();
        } catch (error) {
          if (inlinePages.length) {
            console.warn('Utilisation des pages intégrées.', error);
            return inlinePages;
          }
          throw error;
        }
      };

      const updateIndicators = (current, total, title) => {
        pageIndicator.textContent = `Page ${current} / ${total}`;
        pageTitle.textContent = title || 'Sans titre';
        scrubCount.textContent = `Page ${current}`;
        totalCount.textContent = `/ ${total}`;
        pageScrubber.value = `${current}`;
      };

      const createPages = (pages) => {
        const container = document.createElement('div');
        pages.forEach((page) => {
          const sheet = document.createElement('div');
          sheet.className = 'page';
          if (page.isCover) {
            sheet.classList.add('page--cover');
            sheet.dataset.density = 'hard';
          }
          const img = document.createElement('img');
          img.src = page.src;
          img.alt = page.title || '';
          img.loading = 'lazy';
          img.decoding = 'async';
          sheet.appendChild(img);
          container.appendChild(sheet);
        });
        return container.children;
      };

      const renderFallback = (pages) => {
        bookEl.classList.add('book-fallback');
        bookEl.innerHTML = '';
        fallbackActive = true;
        fallbackPages = pages;
        const pageNodes = createPages(pages);
        Array.from(pageNodes).forEach((page) => bookEl.appendChild(page));

        const total = pages.length;
        pageScrubber.max = `${total}`;
        updateIndicators(1, total, pages[0]?.title);

        pageScrubber.addEventListener('input', (event) => {
          const targetPage = Math.max(0, Number(event.target.value) - 1);
          bookEl.scrollTo({
            left: bookEl.clientWidth * targetPage,
            behavior: 'smooth',
          });
          updateIndicators(targetPage + 1, total, pages[targetPage]?.title);
        });

        const updateFromScroll = () => {
          const index = Math.round(bookEl.scrollLeft / bookEl.clientWidth);
          updateIndicators(index + 1, total, pages[index]?.title);
          pageScrubber.value = `${index + 1}`;
        };

        bookEl.addEventListener('scroll', () => {
          window.requestAnimationFrame(updateFromScroll);
        });
      };

      const navigateFallback = (direction) => {
        const total = fallbackPages.length;
        if (!total) return;
        const currentIndex = Math.round(bookEl.scrollLeft / bookEl.clientWidth);
        const nextIndex = Math.max(0, Math.min(total - 1, currentIndex + direction));
        bookEl.scrollTo({
          left: bookEl.clientWidth * nextIndex,
          behavior: 'smooth',
        });
        updateIndicators(nextIndex + 1, total, fallbackPages[nextIndex]?.title);
        pageScrubber.value = `${nextIndex + 1}`;
      };

      const initBook = (pages) => {
        if (!pages.length) {
          pageIndicator.textContent = 'Pages indisponibles.';
          return;
        }

        if (!window.PageFlip) {
          renderFallback(pages);
          return;
        }

        const pagesWithCoverMeta = pages.map((page, index) => ({
          ...page,
          isCover: index === 0 || index === pages.length - 1,
        }));

        const book = new window.PageFlip(bookEl, {
          width: 820,
          height: 520,
          size: 'stretch',
          minWidth: 420,
          maxWidth: 1100,
          minHeight: 320,
          maxHeight: 760,
          showCover: true,
          flippingTime: 900,
          useMouseEvents: true,
          drawShadow: true,
          maxShadowOpacity: 0.7,
          showPageCorners: true,
          swipeDistance: 40,
          mobileScrollSupport: false,
          usePortrait: false,
        });
        bookInstance = book;

        book.loadFromHTML(createPages(pagesWithCoverMeta));

        const total = book.getPageCount();
        pageScrubber.max = `${total}`;

        const updateFromIndex = (index) => {
          const safeIndex = Math.max(0, Math.min(total - 1, index));
          const meta = pagesWithCoverMeta[safeIndex] || {};
          updateIndicators(safeIndex + 1, total, meta.title);
        };

        updateFromIndex(0);

        book.on('flip', (event) => {
          updateFromIndex(event.data);
        });

        pageScrubber.addEventListener('input', (event) => {
          const targetPage = Number(event.target.value) - 1;
          book.flip(targetPage);
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'ArrowLeft') {
            book.flipPrev();
          }
          if (event.key === 'ArrowRight') {
            book.flipNext();
          }
        });
      };

      navButtons.forEach((button) => {
        button.addEventListener('click', () => {
          if (fallbackActive) {
            navigateFallback(button.dataset.action === 'prev' ? -1 : 1);
            return;
          }
          if (!bookInstance) return;
          if (button.dataset.action === 'prev') {
            bookInstance.flipPrev();
          } else {
            bookInstance.flipNext();
          }
        });
      });

      loadPages()
        .then(initBook)
        .catch((error) => {
          pageIndicator.textContent = 'Pages indisponibles.';
          console.error(error);
        });
    })();
  </script>
</body>
</html>
