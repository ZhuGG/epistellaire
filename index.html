<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Epistellaire — Livre numérique</title>
  <meta name="description" content="Feuilletez l’univers d’Epistellaire : un livre numérique pensé comme une œuvre d’art immersive." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/page-flip/dist/css/page-flip.min.css" />
  <style>
    :root {
      color-scheme: only light;
      --bg: #f9f6f2;
      --bg-accent: #f1ede6;
      --text-primary: #2f2538;
      --text-secondary: rgba(47, 37, 56, 0.68);
      --accent: #b48fbf;
      --accent-strong: #9d7bb5;
      --surface: rgba(255, 255, 255, 0.92);
      --surface-stroke: rgba(182, 164, 198, 0.28);
      --shadow: 0 28px 72px rgba(110, 98, 132, 0.18);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      color: var(--text-primary);
      background: linear-gradient(140deg, #fdfbf7 0%, #f5f1ec 52%, var(--bg) 100%);
      position: relative;
      overflow-x: hidden;
    }

    .page-shell {
      min-height: 100vh;
      position: relative;
      display: flex;
      flex-direction: column;
      padding: clamp(32px, 5vw, 56px) clamp(20px, 6vw, 72px);
      gap: clamp(32px, 5vw, 56px);
    }

    .page-shell::after {
      content: "";
      position: absolute;
      inset: 12% auto auto 55%;
      width: 480px;
      height: 480px;
      background: radial-gradient(circle, rgba(196, 182, 214, 0.32) 0, rgba(196, 182, 214, 0) 70%);
      filter: blur(18px);
      opacity: 0.5;
      pointer-events: none;
      z-index: -1;
      transform: translate(-25%, -10%);
    }

    .site-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
    }

    .signature {
      font-family: "Playfair Display", "Times New Roman", serif;
      font-size: clamp(1.25rem, 2.4vw, 2rem);
      letter-spacing: 0.24rem;
      text-transform: uppercase;
      margin: 0;
    }

    .header-note {
      margin: 0;
      font-size: 0.95rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(47, 37, 56, 0.52);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 440px) minmax(0, 1fr);
      gap: clamp(32px, 5vw, 80px);
      align-items: center;
    }

    .intro h1 {
      margin: 0 0 16px;
      font-family: "Playfair Display", "Times New Roman", serif;
      font-size: clamp(2.4rem, 4vw, 3.6rem);
      line-height: 1.1;
      letter-spacing: 0.04em;
      font-weight: 500;
    }

    .intro p {
      margin: 0 0 1.4rem;
      color: var(--text-secondary);
      font-size: clamp(1rem, 1.3vw, 1.2rem);
      line-height: 1.6;
      max-width: 34ch;
    }

    .intro .cta {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      margin-top: 1.2rem;
    }

    .cta a {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 0.75rem 1.4rem;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(206, 193, 220, 0.6), rgba(190, 209, 218, 0.65));
      box-shadow: 0 12px 24px rgba(120, 110, 143, 0.18);
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 500;
      transition: transform 180ms ease, box-shadow 180ms ease;
    }

    .cta a:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 30px rgba(120, 110, 143, 0.22);
    }

    .viewer {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .book-frame {
      position: relative;
      padding: clamp(18px, 3vw, 28px);
      border-radius: 28px;
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.92), rgba(238, 235, 244, 0.78));
      border: 1px solid var(--surface-stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    #book {
      width: min(100%, 860px);
      height: min(78vh, 680px);
      margin: 0 auto;
      border-radius: 16px;
      overflow: hidden;
    }

    .native-book-viewport {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .native-book-stage {
      position: relative;
      width: min(100%, 520px);
      height: 100%;
      aspect-ratio: 3 / 4;
      max-height: 100%;
      transform: scale(var(--book-scale, 1));
      transform-origin: center;
      transition: transform 220ms ease;
      perspective: 1600px;
      cursor: pointer;
      touch-action: pan-y;
    }

    .native-book-stage::before {
      content: "";
      position: absolute;
      inset: 12% -8% -6%;
      border-radius: 26px;
      background: radial-gradient(
        circle at center,
        rgba(143, 126, 158, 0.28),
        rgba(143, 126, 158, 0)
      );
      transform: translateZ(-1px);
      filter: blur(18px);
      opacity: 0.75;
    }

    .native-sheet {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      border-radius: 18px;
      overflow: hidden;
      background: linear-gradient(160deg, #fdfbf7 0%, #f4f0ea 100%);
      box-shadow: 0 24px 40px rgba(110, 98, 132, 0.16);
      transform-style: preserve-3d;
      backface-visibility: hidden;
      pointer-events: none;
    }

    .native-sheet img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #fdfbf7;
    }

    .native-sheet__shine {
      position: absolute;
      inset: 0;
      background: linear-gradient(
        115deg,
        rgba(255, 255, 255, 0.38) 0%,
        rgba(255, 255, 255, 0) 42%,
        rgba(120, 110, 143, 0.08) 100%
      );
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .native-sheet--standby {
      opacity: 0;
    }

    .native-sheet--current {
      opacity: 1;
      pointer-events: auto;
    }

    .native-sheet--flip-forward,
    .native-sheet--reveal-forward {
      transform-origin: left center;
      animation-duration: 0.85s;
      animation-timing-function: cubic-bezier(0.77, 0, 0.175, 1);
      animation-fill-mode: forwards;
    }

    .native-sheet--flip-backward,
    .native-sheet--reveal-backward {
      transform-origin: right center;
      animation-duration: 0.85s;
      animation-timing-function: cubic-bezier(0.77, 0, 0.175, 1);
      animation-fill-mode: forwards;
    }

    .native-sheet--flip-forward {
      animation-name: nativeFlipForward;
      z-index: 3;
    }

    .native-sheet--reveal-forward {
      animation-name: nativeRevealForward;
      z-index: 2;
    }

    .native-sheet--flip-backward {
      animation-name: nativeFlipBackward;
      z-index: 3;
    }

    .native-sheet--reveal-backward {
      animation-name: nativeRevealBackward;
      z-index: 2;
    }

    @keyframes nativeFlipForward {
      0% {
        transform: rotateY(0deg);
        opacity: 1;
      }
      100% {
        transform: rotateY(-180deg);
        opacity: 0.2;
      }
    }

    @keyframes nativeRevealForward {
      0% {
        transform: rotateY(180deg);
        opacity: 0.1;
      }
      100% {
        transform: rotateY(0deg);
        opacity: 1;
      }
    }

    @keyframes nativeFlipBackward {
      0% {
        transform: rotateY(0deg);
        opacity: 1;
      }
      100% {
        transform: rotateY(180deg);
        opacity: 0.2;
      }
    }

    @keyframes nativeRevealBackward {
      0% {
        transform: rotateY(-180deg);
        opacity: 0.1;
      }
      100% {
        transform: rotateY(0deg);
        opacity: 1;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .native-sheet--flip-forward,
      .native-sheet--reveal-forward,
      .native-sheet--flip-backward,
      .native-sheet--reveal-backward {
        animation-duration: 0.01ms !important;
      }
    }

    .page {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fdfbf7;
    }

    .page img,
    .page iframe,
    .page svg {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }

    .page-indicator {
      margin-top: 16px;
      text-align: center;
      font-size: 0.95rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(47, 37, 56, 0.55);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      padding: 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(182, 164, 198, 0.35);
      backdrop-filter: blur(6px);
    }

    .controls button {
      appearance: none;
      border: none;
      border-radius: 999px;
      padding: 0.6rem 1.05rem;
      background: linear-gradient(135deg, rgba(201, 188, 214, 0.28), rgba(204, 221, 229, 0.32));
      color: var(--text-primary);
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 180ms ease, background 180ms ease, box-shadow 180ms ease;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.45), 0 8px 18px rgba(120, 110, 143, 0.18);
    }

    .controls button:hover,
    .controls button:focus-visible {
      transform: translateY(-1px);
      outline: none;
      background: linear-gradient(135deg, rgba(201, 188, 214, 0.48), rgba(204, 221, 229, 0.48));
    }

    .controls button:active {
      transform: translateY(0);
    }

    footer {
      margin-top: auto;
      color: var(--text-secondary);
      font-size: 0.9rem;
      max-width: 680px;
      line-height: 1.6;
    }

    footer strong {
      color: var(--accent);
      font-weight: 500;
    }

    @media (max-width: 1080px) {
      main {
        grid-template-columns: 1fr;
      }

      .viewer {
        order: -1;
      }

      .intro h1 {
        text-align: center;
      }

      .intro p,
      .intro .cta {
        text-align: center;
        justify-content: center;
      }

      .site-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .header-note {
        letter-spacing: 0.1em;
      }
    }

    @media (max-width: 640px) {
      .page-shell {
        padding: 32px 20px 48px;
      }

      .controls {
        border-radius: 18px;
      }

      #book {
        height: min(70vh, 580px);
      }
    }
  </style>
</head>
<body>
  <div class="page-shell">
    <header class="site-header">
      <p class="signature">Epistellaire</p>
      <p class="header-note">Carnet visuel en évolution</p>
    </header>

    <main>
      <section class="intro">
        <h1>Plonger dans l’œuvre vivante de l’artiste</h1>
        <p>feuilletez, laissez les pages respirer, explorez les détails.</p>
        <p>Utilisez les commandes  ou les flèches du clavier pour naviguer. Revenez régulièrement : la dernière page dévoile les pièces fraichement ajoutées.</p>
        <div class="cta">
          <a href="#book">Commencer la lecture ↗</a>
        </div>
      </section>

      <section class="viewer" aria-label="Visionneuse du livre">
        <div class="book-frame">
          <div id="book" aria-live="polite" aria-label="Livre d’artiste"></div>
          <p class="page-indicator" id="pageIndicator">Préparation du livre…</p>
        </div>
        <div class="controls" role="toolbar" aria-label="Contrôles du livre">
          <button type="button" data-action="first">Première</button>
          <button type="button" data-action="prev">Précédente</button>
          <button type="button" data-action="next">Suivante</button>
          <button type="button" data-action="last">Dernière</button>
          <button type="button" data-action="zoomIn">Zoom +</button>
          <button type="button" data-action="zoomOut">Zoom −</button>
        </div>
      </section>
    </main>

    <footer>
      <p><strong>Astuce&nbsp;:</strong> commandez l’expérience complète en plein écran pour un face-à-face avec l’œuvre, ou laissez le livre ouvert — il accueillera automatiquement la prochaine création de l’artiste.</p>
    </footer>
  </div>

  <script type="application/json" id="pagesData">
    [
      {
        "src": "assets/pages/001.jpg",
        "title": "Couverture"
      },
      {
        "src": "assets/pages/002.jpg",
        "title": "Jour 1"
      },
      {
        "src": "assets/pages/003.svg",
        "title": "Jour 2"
      }
    ]
  </script>

  <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.min.js"></script>
  <script>
    (function () {
      const bookEl = document.getElementById('book');
      const pageIndicator = document.getElementById('pageIndicator');
      const qs = new URLSearchParams(location.search);
      const startAtLast = qs.get('last') !== '0';

      const inlinePages = (() => {
        const el = document.getElementById('pagesData');
        if (!el) return null;
        try {
          return JSON.parse(el.textContent);
        } catch (error) {
          console.warn('Impossible de lire les pages intégrées.', error);
          return null;
        }
      })();

      const loadPages = () => {
        if (location.protocol === 'file:' && inlinePages) {
          return Promise.resolve(inlinePages);
        }

        return fetch('pages.json', { cache: 'no-store' })
          .then((r) => {
            if (!r.ok) {
              throw new Error(`Réponse inattendue du manifest (${r.status})`);
            }
            return r.json();
          })
          .catch((err) => {
            if (inlinePages && inlinePages.length) {
              console.warn(
                'Utilisation des pages intégrées faute de chargement du manifest distant.',
                err,
              );
              return inlinePages;
            }
            throw err;
          });
      };

      const updateIndicator = (current, total, title) => {
        const label = title ? ` — ${title}` : '';
        pageIndicator.textContent = `Page ${current} / ${total}${label}`;
      };

      loadPages()
        .then((pages) => {
          if (!Array.isArray(pages) || pages.length === 0) {
            throw new Error('Aucune page à afficher.');
          }

          const bindControls = (actions) => {
            document.querySelectorAll('[data-action]').forEach((button) => {
              const action = actions[button.dataset.action];
              if (typeof action === 'function') {
                button.addEventListener('click', action);
              }
            });
          };

          const bindKeyboard = (actions) => {
            addEventListener('keydown', (e) => {
              if (e.key === 'ArrowLeft') actions.prev?.();
              if (e.key === 'ArrowRight') actions.next?.();
              if (e.key === '+') actions.zoomIn?.();
              if (e.key === '-' || e.key === '–') actions.zoomOut?.();
            });
          };

          const setupWithPageFlip = () => {
            const book = new window.PageFlip(bookEl, {
              width: 520,
              height: 720,
              size: 'stretch',
              showCover: true,
              useMouseEvents: true,
              maxShadowOpacity: 0.18,
              mobileScrollSupport: true,
            });

            const htmlContainer = document.createElement('div');

            pages.forEach((p) => {
              const el = document.createElement('div');
              el.className = 'page';
              const img = document.createElement('img');
              img.src = p.src;
              img.alt = p.title || '';
              el.appendChild(img);
              htmlContainer.appendChild(el);
            });

            book.loadFromHTML(htmlContainer.children);

            const actions = {
              first: () => book.flip(0),
              prev: () => book.flipPrev(),
              next: () => book.flipNext(),
              last: () => book.flip(book.getPageCount() - 1),
              zoomIn: () => book.update({
                width: book.settings.width * 1.05,
                height: book.settings.height * 1.05,
              }),
              zoomOut: () => book.update({
                width: book.settings.width / 1.05,
                height: book.settings.height / 1.05,
              }),
            };

            const getCurrentIndex = () => {
              if (typeof book.getCurrentPageIndex === 'function') {
                return book.getCurrentPageIndex();
              }
              if (typeof book.getCurrentPage === 'function') {
                return book.getCurrentPage();
              }
              return 0;
            };

            const syncIndicator = (pageIndex) => {
              const total = book.getPageCount();
              if (!total) {
                pageIndicator.textContent = 'Aucune page disponible pour le moment.';
                return;
              }
              const safeIndex = Math.max(0, Math.min(total - 1, pageIndex));
              const current = safeIndex + 1;
              const meta = pages[safeIndex] || {};
              updateIndicator(current, total, meta.title);
            };

            book.on('flip', (e) => {
              syncIndicator(e.data);
            });

            bindControls(actions);
            bindKeyboard(actions);

            requestAnimationFrame(() => {
              if (startAtLast) {
                const lastIndex = Math.max(0, book.getPageCount() - 1);
                book.flip(lastIndex);
                syncIndicator(lastIndex);
              } else {
                syncIndicator(getCurrentIndex());
              }
            });
          };

          const setupFallback = () => {
            console.warn(
              'La bibliothèque PageFlip est indisponible. Activation du feuilletage natif.',
            );
            bookEl.innerHTML = '';

            const clampIndex = (value) => Math.max(0, Math.min(pages.length - 1, value));

            const viewport = document.createElement('div');
            viewport.className = 'native-book-viewport';

            const stage = document.createElement('div');
            stage.className = 'native-book-stage';
            stage.style.setProperty('--book-scale', '1');

            const createSheet = (name) => {
              const el = document.createElement('figure');
              el.className = `native-sheet native-sheet--${name} native-sheet--standby`;
              el.setAttribute('aria-hidden', 'true');

              const img = document.createElement('img');
              img.decoding = 'async';
              img.loading = 'lazy';
              el.appendChild(img);

              const shine = document.createElement('div');
              shine.className = 'native-sheet__shine';
              el.appendChild(shine);

              return { el, img };
            };

            let currentSheet = createSheet('current');
            let standbySheet = createSheet('standby');

            stage.append(currentSheet.el, standbySheet.el);
            viewport.append(stage);
            bookEl.appendChild(viewport);

            let currentIndex = clampIndex(startAtLast ? pages.length - 1 : 0);
            let currentScale = 1;
            let isFlipping = false;
            const prefersReducedMotion =
              typeof window.matchMedia === 'function' &&
              window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            const preloaded = new Set();

            const preloadAround = (index) => {
              [index - 1, index + 1].forEach((i) => {
                const meta = pages[clampIndex(i)];
                if (!meta || meta === pages[index] || preloaded.has(meta.src)) return;
                preloaded.add(meta.src);
                const img = new Image();
                img.src = meta.src;
              });
            };

            const updateSheet = (sheet, meta) => {
              if (!meta) {
                sheet.el.classList.add('native-sheet--standby');
                sheet.el.classList.remove('native-sheet--current');
                sheet.el.setAttribute('aria-hidden', 'true');
                sheet.img.removeAttribute('src');
                sheet.img.alt = '';
                return;
              }

              sheet.el.classList.remove('native-sheet--standby');
              sheet.el.classList.remove('native-sheet--current');
              sheet.el.setAttribute('aria-hidden', 'false');
              sheet.img.src = meta.src;
              sheet.img.alt = meta.title || '';
            };

            const applyScale = () => {
              stage.style.setProperty('--book-scale', currentScale.toFixed(3));
            };

            const syncState = () => {
              const meta = pages[currentIndex];
              updateSheet(currentSheet, meta);
              currentSheet.el.classList.add('native-sheet--current');
              currentSheet.el.setAttribute('aria-hidden', 'false');
              updateSheet(standbySheet, null);
              updateIndicator(currentIndex + 1, pages.length, meta?.title);
              applyScale();
              preloadAround(currentIndex);
            };

            const flipTo = (targetIndex) => {
              const safeTarget = clampIndex(targetIndex);
              if (safeTarget === currentIndex || isFlipping) {
                return;
              }

              if (prefersReducedMotion) {
                currentIndex = safeTarget;
                syncState();
                return;
              }

              const direction = safeTarget > currentIndex ? 'forward' : 'backward';
              isFlipping = true;

              const revealClass =
                direction === 'forward'
                  ? 'native-sheet--reveal-forward'
                  : 'native-sheet--reveal-backward';
              const flipClass =
                direction === 'forward'
                  ? 'native-sheet--flip-forward'
                  : 'native-sheet--flip-backward';

              updateSheet(standbySheet, pages[safeTarget]);
              standbySheet.el.classList.remove('native-sheet--current');
              standbySheet.el.classList.remove('native-sheet--standby');
              standbySheet.el.classList.add(revealClass);

              currentSheet.el.classList.remove('native-sheet--current');
              currentSheet.el.classList.add(flipClass);

              let finished = 0;
              const handleAnimationEnd = (event) => {
                if (event.target !== event.currentTarget) return;
                finished += 1;
                if (finished < 2) return;

                currentSheet.el.classList.remove(flipClass);
                currentSheet.el.classList.add('native-sheet--standby');
                currentSheet.el.setAttribute('aria-hidden', 'true');

                standbySheet.el.classList.remove(revealClass);
                standbySheet.el.classList.add('native-sheet--current');

                currentSheet.el.removeEventListener('animationend', handleAnimationEnd);
                standbySheet.el.removeEventListener('animationend', handleAnimationEnd);

                const temp = currentSheet;
                currentSheet = standbySheet;
                standbySheet = temp;

                currentIndex = safeTarget;
                updateIndicator(currentIndex + 1, pages.length, pages[currentIndex]?.title);
                updateSheet(standbySheet, null);
                preloadAround(currentIndex);

                isFlipping = false;
              };

              currentSheet.el.addEventListener('animationend', handleAnimationEnd);
              standbySheet.el.addEventListener('animationend', handleAnimationEnd);

              // force reflow to allow animation to trigger consistently
              void standbySheet.el.offsetWidth;
            };

            const actions = {
              first: () => flipTo(0),
              prev: () => flipTo(currentIndex - 1),
              next: () => flipTo(currentIndex + 1),
              last: () => flipTo(pages.length - 1),
              zoomIn: () => {
                currentScale = Math.min(currentScale + 0.12, 1.7);
                applyScale();
              },
              zoomOut: () => {
                currentScale = Math.max(currentScale - 0.12, 0.7);
                applyScale();
              },
            };

            stage.addEventListener('click', (event) => {
              const rect = stage.getBoundingClientRect();
              const isLeft = event.clientX - rect.left < rect.width / 2;
              if (isLeft) {
                actions.prev();
              } else {
                actions.next();
              }
            });

            bindControls(actions);
            bindKeyboard(actions);
            syncState();
          };

          if (typeof window.PageFlip === 'function') {
            setupWithPageFlip();
          } else {
            setupFallback();
          }
        })
        .catch((err) => {
          pageIndicator.textContent = 'Les pages seront bientôt disponibles.';
          bookEl.innerHTML =
            '<p style="padding:1rem; text-align:center; color: rgba(47, 37, 56, 0.7)">La collection est en cours de préparation.</p>';
          console.error(err);
        });
    })();
  </script>
</body>
</html>
